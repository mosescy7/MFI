---
title: "Microfinance Prudential Norms - CAR Breakdown"
author: "Moses Cyabukombe"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
# ---------------------------------------------------------
# Global chunk options
# ---------------------------------------------------------
knitr::opts_chunk$set(
  echo = TRUE,        # show code for documentation
  message = FALSE,    # suppress messages
  warning = FALSE     # suppress warnings
)
# ---------------------------------------------------------
# Create a connection to EDWH (Oracle / Vision schema)
# NOTE:
# - Replace DSN, UID, and PWD with secure credentials
# - In production, credentials should be stored securely
# ---------------------------------------------------------

con <- DBI::dbConnect(
  odbc::odbc(),
  Driver   = "Oracle",
  Host     = "172.16.1.17",
  Port     = 1521,
  Service  = "dwhrpddb.bnr.rw",
  UID      = "MCYABUKOMBE",
  PWD      = Sys.getenv("EDWH_PWD")
)

# ---------------------------------------------------------
# SQL Query Explanation:
# - LE_BOOK       : Reporting institution
# - YEAR_MONTH    : Reporting period
# - CAR_LINE_CODE_DESC : CAR component description
# - VALUE_LCY     : Aggregated CAR values in local currency
#
# This query prepares CAR data for pivoting in R
# ---------------------------------------------------------

query <- "
SELECT
    ca.LE_BOOK,
    ca.YEAR_MONTH,
    ast.ALPHA_SUBTAB_DESCRIPTION AS CAR_LINE_CODE_DESC,
    SUM(ca.VALUE_LCY) AS VALUE_LCY
FROM vision.CAPITAL_AR ca
LEFT JOIN vision.ALPHA_SUB_TAB ast
    ON ast.ALPHA_TAB = 5005
   AND ast.ALPHA_SUB_TAB = ca.CAR_LINE_CODE
GROUP BY
    ca.LE_BOOK,
    ca.YEAR_MONTH,
    ast.ALPHA_SUBTAB_DESCRIPTION
ORDER BY
    ca.LE_BOOK,
    ca.YEAR_MONTH,
    ast.ALPHA_SUBTAB_DESCRIPTION
"
# ---------------------------------------------------------
# Execute query and bring data into R
# ---------------------------------------------------------

capital_ar_raw <- dbGetQuery(con, query)

# Quick structure check
str(capital_ar_raw)
# ---------------------------------------------------------
# Pivot Explanation:
# - Each CAR_LINE_CODE_DESC becomes a column
# - VALUE_LCY becomes the values
# - Missing CAR components are filled with 0
#
# Final structure:
# LE_BOOK | YEAR_MONTH | Tier 1 Capital | Tier 2 Capital | ...
# ---------------------------------------------------------

capital_ar_pivot <- capital_ar_raw %>%
  pivot_wider(
    names_from  = CAR_LINE_CODE_DESC,
    values_from = VALUE_LCY,
    values_fill = 0
  )

# View final dataset
head(capital_ar_pivot)
# ---------------------------------------------------------
# Always close the database connection
# ---------------------------------------------------------
dbDisconnect(con)
