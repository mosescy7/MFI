---
title: "Microfinance Prudential Norms - CAR Breakdown"
author: "Moses Cyabukombe"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
# ---------------------------------------------------------
# Global chunk options
# ---------------------------------------------------------
knitr::opts_chunk$set(
  echo = TRUE,        # show code for documentation
  message = FALSE,    # suppress messages
  warning = FALSE     # suppress warnings
)
# install.packages(c("odbc", "DBI", "dplyr", "tidyr"))
#install.packages("ROracle")
# install.packages("rlang")

library(DBI)
library(odbc)
library(dplyr)
library(tidyr)
```

```{r connection}
# ---------------------------------------------------------
# Create a connection to EDWH (Oracle / Vision schema)
# ---------------------------------------------------------

con <- DBI::dbConnect(
  odbc::odbc(),
  Driver = "Oracle in OraDB21Home1",
  DBQ    = "172.16.1.17:1521/dwhrpddb.bnr.rw",
  UID    = "MCYABUKOMBE",
  PWD    = Sys.getenv("Vision123Mbe")
)
```

```{r query}
# ---------------------------------------------------------
# SQL Query Explanation:
# - LE_BOOK       : Reporting institution
# - YEAR_MONTH    : Reporting period
# - CAR_LINE_CODE_DESC : CAR component description
# - VALUE_LCY     : Aggregated CAR values in local currency
#
# This query prepares CAR data for pivoting in R
# ---------------------------------------------------------

query <- "
SELECT
    ca.LE_BOOK,
    ca.YEAR_MONTH,
    ast.ALPHA_SUBTAB_DESCRIPTION AS CAR_LINE_CODE_DESC,
    SUM(ca.VALUE_LCY) AS VALUE_LCY
FROM vision.CAPITAL_AR ca
LEFT JOIN vision.ALPHA_SUB_TAB ast
    ON ast.ALPHA_TAB = 5005
   AND ast.ALPHA_SUB_TAB = ca.CAR_LINE_CODE
GROUP BY
    ca.LE_BOOK,
    ca.YEAR_MONTH,
    ast.ALPHA_SUBTAB_DESCRIPTION
ORDER BY
    ca.LE_BOOK,
    ca.YEAR_MONTH,
    ast.ALPHA_SUBTAB_DESCRIPTION
"

capital_ar_raw <- DBI::dbGetQuery(con, query)

str(capital_ar_raw)
```

```{r pivot}
# ---------------------------------------------------------
# Pivot: Each CAR_LINE_CODE_DESC becomes a column
# ---------------------------------------------------------

capital_ar_pivot <- capital_ar_raw %>%
  pivot_wider(
    names_from  = CAR_LINE_CODE_DESC,
    values_from = VALUE_LCY,
    values_fill = 0
  )

head(capital_ar_pivot)
```

```{r cleanup}
# ---------------------------------------------------------
# Always close the database connection
# ---------------------------------------------------------
DBI::dbDisconnect(con)
```
